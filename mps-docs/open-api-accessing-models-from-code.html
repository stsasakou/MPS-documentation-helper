<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><link rel="canonical" href="https://www.jetbrains.com/help/mps/open-api-accessing-models-from-code.html" data-react-helmet="true"/><meta charset="UTF-8"></meta><meta name="built-on" content="2024-08-08T15:14:17.303119001"><meta name="build-number" content="170"><title>Open API - accessing models from code | MPS Documentation</title><script type="application/json" id="virtual-toc-data">[{"id":"usingopenapi","level":0,"title":"Using Open API","anchor":"#usingopenapi"},{"id":"someapidetails","level":0,"title":"Some API details","anchor":"#someapidetails"},{"id":"usingcommands","level":0,"title":"Using commands","anchor":"#usingcommands"},{"id":"concurrentaccess","level":0,"title":"Concurrent access","anchor":"#concurrentaccess"},{"id":"custompersistence","level":0,"title":"Custom persistence","anchor":"#custompersistence"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/storage/help-app/v6/app.css" rel="stylesheet"><link rel="manifest" href="https://www.jetbrains.com/site.webmanifest"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content="https://resources.jetbrains.com/storage/products/mps/img/meta/preview.png"><!-- Open Graph --><meta property="og:title" content="Open API - accessing models from code | MPS"><meta property="og:description" content=""><meta property="og:image" content="https://resources.jetbrains.com/storage/products/mps/img/meta/preview.png"><meta property="og:site_name" content="MPS Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://www.jetbrains.com/help/mps/open-api-accessing-models-from-code.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@jetbrains_MPS"><meta name="twitter:title" content="Open API - accessing models from code | MPS"><meta name="twitter:description" content=""><meta name="twitter:creator" content="@jetbrains_MPS"><meta name="twitter:image:src" content="https://resources.jetbrains.com/storage/products/mps/img/meta/preview.png"><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "https://www.jetbrains.com/help/mps/open-api-accessing-models-from-code.html#webpage",
    "url": "https://www.jetbrains.com/help/mps/open-api-accessing-models-from-code.html",
    "name": "Open API - accessing models from code | MPS",
    "description": "",
    "image": "https://resources.jetbrains.com/storage/products/mps/img/meta/preview.png",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "https://www.jetbrains.com/help/mps/#website",
    "url": "https://www.jetbrains.com/help/mps/",
    "name": "MPS Help"
}</script><!-- End Schema.org --><script>
    (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
        var f = d.getElementsByTagName(s)[0], j = d.createElement(s), dl = l != 'dataLayer' ? '&amp;l=' + l : '';
        j.async = true;
        j.src = '//www.googletagmanager.com/gtm.js?id=' + i + dl;
        f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-5P98');
</script>
<script src="https://resources.jetbrains.com/storage/help-app/v6/analytics.js"></script>
</head><body data-id="open-api-accessing-models-from-code" data-main-title="Open API - accessing models from code" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="mps-user-s-guide.topic|MPS User's Guide///platform-languages.topic|Platform-languages///smodel-language.topic|SModel language"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>MPS 2024.1 Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="open-api-accessing-models-from-code" id="open-api-accessing-models-from-code.topic">Open API - accessing models from code</h1><p id="c7kso2_1">The language repository, project modules, languages and models can be conveniently accessed programmatically through Open API.&nbsp;Open API gives you controlled access to the model and also allows you to provide your own implementations for some aspects, such as persistence.</p><p id="c7kso2_2">These two usage types will be discussed individually.</p><p id="c7kso2_3"><em id="c7kso2_4">Note:&nbsp;This document is meant to provide a general high-level overview of the Open API philosophy and give you useful starting links to the API. For technical details on how to use it please consult</em> <em id="c7kso2_5"></em> <em id="c7kso2_6">.</em></p><aside class="prompt" data-type="tip" data-title="" id="c7kso2_7"><p id="c7kso2_8">For hands-on code examples of using the API please check out&nbsp; <a href="using-model-module-dependencies-faq.html" id="c7kso2_9">Using model &amp; module dependencies FAQ</a></p></aside><section class="chapter"><h2 id="usingopenapi" data-toc="usingopenapi">Using Open API</h2><p id="c7kso2_10">The API is located under the <em id="c7kso2_11">org.jetbrains.mps.openapi</em>&nbsp;package and is divided into several sub-packages:</p><ul class="list _bullet" id="c7kso2_12"><li class="list__item" id="c7kso2_13"><p><em id="c7kso2_14">event</em> - contains event classes for changes to the model</p></li><li class="list__item" id="c7kso2_15"><p><em id="c7kso2_16">language</em>&nbsp;- provides a set of interfaces to gain access to compiled languages and inspect their structure</p></li><li class="list__item" id="c7kso2_17"><p><em id="c7kso2_18">model</em>&nbsp;- gives you ways to inspect and modify the models (ASTs)</p></li><li class="list__item" id="c7kso2_19"><p><em id="c7kso2_20">module</em>&nbsp;- abstracts repositories and modules as means to logically organize models</p></li><li class="list__item" id="c7kso2_21"><p><em id="c7kso2_22">persistence</em>&nbsp;- holds the interfaces necessary to extend and customize the persistence mechanism for models</p></li><li class="list__item" id="c7kso2_23"><p><em id="c7kso2_24">repository</em> - holds listeners to repository-specific events</p></li><li class="list__item" id="c7kso2_25"><p><em id="c7kso2_26">util</em>&nbsp;- contains utility classes, such as <em id="c7kso2_27">ProgressMonitor</em>&nbsp;to hook long-lasting actions to UI progress indicators</p></li></ul><p id="c7kso2_28">The API recognizes these logical elements, with the ones above containing the ones below in the list:</p><ul class="list _bullet" id="c7kso2_29"><li class="list__item" id="c7kso2_30"><p>Repository</p></li><li class="list__item" id="c7kso2_31"><p>Module</p></li><li class="list__item" id="c7kso2_32"><p>Model</p></li><li class="list__item" id="c7kso2_33"><p>Node</p></li><li class="list__item" id="c7kso2_34"><p>Properties, References</p></li></ul><p id="c7kso2_35">Open API also recognizes meta-structure, which is orthogonal to the elements above. The meta-structure consists of the following key elements:</p><ul class="list _bullet" id="c7kso2_36"><li class="list__item" id="c7kso2_37"><p>Language</p></li><li class="list__item" id="c7kso2_38"><p>Concept, Enumeration</p></li><li class="list__item" id="c7kso2_39"><p>Members (such as properties, links and enum literals)</p></li></ul><p id="c7kso2_40">Each&nbsp;<em id="c7kso2_41">node</em>&nbsp;has an associated&nbsp;<em id="c7kso2_42">concept</em>. A concept belongs to a <em id="c7kso2_43">Language</em> .&nbsp;<em id="c7kso2_44">Languages</em> may keep a pointer to the source&nbsp;<em id="c7kso2_45">module</em>&nbsp;that they originated from to give the language user a way to investigate the language in detail.</p><p id="c7kso2_46">The API enables you to browse the whole repository and investigate its modules, their models as well as the nodes that these models are built from. Additionally the API has capabilities to search for element's usages or find any element by its name irrespective of its location within the repository.&nbsp;You can also modify all of these elements, save your changes or reload them from a persistent storage. The API will detect colliding modifications to the model in memory and its persistent storage.</p></section><section class="chapter"><h2 id="someapidetails" data-toc="someapidetails">Some API details</h2><p id="c7kso2_47">Downcast from smodel types to Open API types happens automatically when you assign an expression typed to one of the smodel types to a variable typed to an Open API type:</p><div class="code-block" data-lang="none">
            node&lt;&gt; n1 = ...
            SNode n2 = n1
        </div><p id="c7kso2_49">Up-casting happens when you do the opposite:</p><div class="code-block" data-lang="none">
                SNode n1 = ...
                node&lt;&gt; n2 = n1
            </div><section class="chapter"><h3 id="meta-modellevel" data-toc="meta-modellevel">Meta-model level</h3><section class="chapter"><h4 id="sabstractconcept" data-toc="sabstractconcept">SAbstractConcept</h4><ul class="list _bullet" id="c7kso2_51"><li class="list__item" id="c7kso2_52"><p>a common super-class to both&nbsp;<em id="c7kso2_53">SConcept</em>&nbsp;and&nbsp; <em id="c7kso2_54">SConceptInterface</em></p></li><li class="list__item" id="c7kso2_55"><p>gives access to concept's <b id="c7kso2_56">properties</b>, <b id="c7kso2_57">containment links</b>&nbsp;and <b id="c7kso2_58">reference links</b></p></li><li class="list__item" id="c7kso2_59"><p>use the <em id="c7kso2_60">getProperties()</em>, <em id="c7kso2_61">getContainmentLinks()</em>&nbsp;and <em id="c7kso2_62">getReferenceLinks()</em>&nbsp;methods to obtain concept's properties, containment and reference links, respectively</p></li></ul></section><section class="chapter"><h4 id="sproperty" data-toc="sproperty">SProperty</h4><ul class="list _bullet" id="c7kso2_63"><li class="list__item" id="c7kso2_64"><p>represents a property</p></li></ul></section><section class="chapter"><h4 id="scontainmentlink" data-toc="scontainmentlink">SContainmentLink</h4><ul class="list _bullet" id="c7kso2_65"><li class="list__item" id="c7kso2_66"><p>represents a containment (parent-child) relationship between concepts</p></li></ul></section><section class="chapter"><h4 id="sreferencelink" data-toc="sreferencelink">SReferenceLink</h4><ul class="list _bullet" id="c7kso2_67"><li class="list__item" id="c7kso2_68"><p>represents an explicit (reference) relationship between concepts</p></li></ul></section></section><section class="chapter"><h3 id="modellevel" data-toc="modellevel">Model level</h3><section class="chapter"><h4 id="snode" data-toc="snode">SNode</h4><ul class="list _bullet" id="c7kso2_69"><li class="list__item" id="c7kso2_70"><p>represents individual nodes in the model</p></li></ul></section><section class="chapter"><h4 id="sreference" data-toc="sreference">SReference</h4><ul class="list _bullet" id="c7kso2_71"><li class="list__item" id="c7kso2_72"><p>represents references between nodes</p></li></ul></section><section class="chapter"><h4 id="snodereference" data-toc="snodereference">SNodeReference</h4><ul class="list _bullet" id="c7kso2_73"><li class="list__item" id="c7kso2_74"><p>a unique global reference to a node that can be persisted and used repeatedly to obtain a node from a repository</p></li></ul></section></section><section class="chapter"><h3 id="openapiusagepatterns" data-toc="openapiusagepatterns">Open API usage patterns</h3><section class="chapter"><h4 id="settingaproperty" data-toc="settingaproperty">Setting a property</h4><div class="code-block" data-lang="none">Iterable&lt;SProperty&gt; properties = concept/Shape/.getProperties();&nbsp;
                    list&lt;SProperty&gt; props = new arraylist&lt;SProperty&gt;(copy: properties);&nbsp;
                    currentNode/.setProperty(props.findFirst({~it =&gt; it.getName() :eq: "foo"; }), "value");
                </div></section><section class="chapter"><h4 id="addingachild" data-toc="addingachild">Adding a child</h4><div class="code-block" data-lang="none">Iterable&lt;SContainmentLink&gt; containmentLinks =
                    concept/Shape/.getContainmentLinks();&nbsp;
                    list&lt;SContainmentLink&gt; containments = new arraylist&lt;SContainmentLink&gt;(copy:
                    containmentLinks);
                    currentNode/.addChild(containmentLinks.findFirst(...), childNode);
                </div></section></section></section><section class="chapter"><h2 id="usingcommands" data-toc="usingcommands">Using commands</h2><p id="c7kso2_77">Open API provides means to alter the models, as well.&nbsp;Modifications need to be performed as commands that are passed to the repository for processing.&nbsp;Typical model-changing/editing actions can be un-done/re-done, while actions performing major changes to the module structure cannot.&nbsp;There are three types of changes:</p><ol class="list _decimal" id="c7kso2_78" type="1"><li class="list__item" id="c7kso2_79"><p>models and nodes can be changed through&nbsp; <b id="c7kso2_80">undoable actions</b></p></li><li class="list__item" id="c7kso2_81"><p>modules, their properties and dependencies can be performed through&nbsp; <b id="c7kso2_82">repository commands</b></p></li><li class="list__item" id="c7kso2_83"><p>radical changes to the project, such as a VCS update or a complete project reload, need an&nbsp;<b id="c7kso2_84">external update action</b>&nbsp;to be performed - no node-level notifications are fired in such cases,&nbsp;only <b id="c7kso2_85">model replaced</b> or <b id="c7kso2_86">module changed</b> notifications are triggered.</p></li></ol><p id="c7kso2_87">The commands depending on their type will have all the necessary read or write permission assigned automatically before they start changing the model. Change notifications are fired to the registered listeners on the node, model, module or repository levels.</p></section><section class="chapter"><h2 id="concurrentaccess" data-toc="concurrentaccess">Concurrent access</h2><p id="c7kso2_88">Open API is designed for concurrent access and will correctly handle multiple threads accessing the models through Open API simultaneously, provided the supplied synchronization mechanisms are correctly utilized by the calling code. Open API will reject all improperly synchronized requests and thus preserve the integrity of the models.</p><p id="c7kso2_89">In a more concrete terms, you need to obtain a read or write action before you start performing your operations, otherwise you'd get exceptions fired from the code.</p><p id="c7kso2_90">Use <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/module/SRepository.java" id="c7kso2_91" data-external="true" rel="noopener noreferrer">SRepository</a>. <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/module/RepositoryAccess.java" id="c7kso2_92" data-external="true" rel="noopener noreferrer">getRepositoryAccess()</a> .applyChanges()&nbsp;to have your changes applied to the whole repository&nbsp;<a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/module/SRepository.java" id="c7kso2_93" data-external="true" rel="noopener noreferrer">SRepository</a>. <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/module/ModelAccess.java" id="c7kso2_94" data-external="true" rel="noopener noreferrer">getModelAccess()</a> .runXXXAction()&nbsp;to run a read/write action and <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/module/SRepository.java" id="c7kso2_95" data-external="true" rel="noopener noreferrer">SRepository</a>. <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/module/ModelAccess.java" id="c7kso2_96" data-external="true" rel="noopener noreferrer">getModelAccess()</a> .executeCommand()&nbsp;to run a command.&nbsp;Commands get all write permissions automatically and so always gain exclusive access to the repository. Both methods offer an asynchronous variant that runs the supplied action asynchronously in the EDT.</p><section class="chapter"><h3 id="model-lockingexample" data-toc="model-lockingexample">Model-locking example</h3><p id="c7kso2_97"><em id="c7kso2_98">SRepository</em>&nbsp;is the right place to start locking the model. You can obtain an <em id="c7kso2_99">SRepository</em> reference from context objects, such as <em id="c7kso2_100">EditorContext</em>. Your code can than obtain <em id="c7kso2_101">ModelAccess</em>&nbsp;and get the lock:</p><div class="code-block" data-lang="none">(node, editorContext)-&gt;JComponent {&nbsp;
                //get ModelAccess from the context
                final ModelAccess modelAccess = editorContext.getRepository().getModelAccess();&nbsp;
                &nbsp;
                //read the model
                final boolean[] active = new boolean[]{false};
                modelAccess.runReadAction(new Runnable() {
                public void run() {
                active[0] = node.showActive;
                }
                });

                final JButton button = new JButton(active[0] ? "Show all" : "Show active");
                button.addActionListener(new ActionListener() {

                public void actionPerformed(ActionEvent p0) {&nbsp;
                //update the model in an action, that can be undone
                modelAccess.executeCommand(new Runnable() {
                public void run() {
                node.showActive = !node.showActive;
                }
                });
                }
                });
                return button;
                }
                &nbsp;
            </div></section></section><section class="chapter"><h2 id="custompersistence" data-toc="custompersistence">Custom persistence</h2><p id="c7kso2_103">By default MPS stores models as flat files in an XML or binary format. To allow you to&nbsp;customize the way your models are persisted, Open API provides gives you several options.</p><section class="chapter"><h3 id="alternativefileformat" data-toc="alternativefileformat">Alternative file format</h3><p id="c7kso2_104">Changing the format of model data stored in a flat file is the simplest way to customize model persistence. You simply register your own <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/ModelFactory.java" id="c7kso2_105" data-external="true" rel="noopener noreferrer">ModelFactory</a>&nbsp;with the file extension of your choice (through <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/PersistenceFacade.java" id="c7kso2_106" data-external="true" rel="noopener noreferrer">PersistenceFacade</a>) and MPS will use that factory to instantiate your custom&nbsp;<a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/model/SModel.java" id="c7kso2_107" data-external="true" rel="noopener noreferrer">SModel</a>&nbsp;implementations whenever that file extension is discovered. You'll also need to provide and register your own implementations of <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/SModelIdFactory.java" id="c7kso2_108" data-external="true" rel="noopener noreferrer">SModelIdFactory</a> and <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/SNodeIdFactory.java" id="c7kso2_109" data-external="true" rel="noopener noreferrer">SNodeIdFactory</a>.</p></section><section class="chapter"><h3 id="alternativestorage" data-toc="alternativestorage">Alternative storage</h3><p id="c7kso2_110">If you're more adventurous and want, for example, to load your models from a database or other non-file storage, you need to additionally provide a&nbsp;<a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/ModelRootFactory.java" id="c7kso2_111" data-external="true" rel="noopener noreferrer">ModelRootFactory</a>, which can create custom <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/ModelRoot.java" id="c7kso2_112" data-external="true" rel="noopener noreferrer">ModelRoot</a> instances. These model roots will then handle all the specifics of your chosen storage in order to load/save models. You may typically also need to bundle UI that would allow the users to configure data source details, such as database location, user name or other.</p><aside class="prompt" data-type="tip" data-title="" id="c7kso2_113"><p id="c7kso2_114">The <b id="c7kso2_115">xmlPersistence</b> sample project that comes bundled with MPS shows a non-trivial example of implementing custom persistence. Check out the description of the <a href="custom-persistence-cookbook.html" id="c7kso2_116">Custom Persistence Cookbook</a> for practical details on how to provide your own persistence to MPS models in MPS as well as IDEA.</p></aside></section><section class="chapter"><h3 id="customfindusageandnavigationparticipants" data-toc="customfindusageandnavigationparticipants">Custom Find Usage and Navigation participants</h3><p id="c7kso2_117">Providing a custom implementation of <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/FindUsagesParticipant.java" id="c7kso2_118" data-external="true" rel="noopener noreferrer">FindUsagesParticipant</a>&nbsp;will allow you to&nbsp;optimize <em id="c7kso2_119">FindUsages</em>&nbsp;in models using your custom persistence. Similarly, custom implementations of <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/NavigationParticipant.java" id="c7kso2_120" data-external="true" rel="noopener noreferrer">NavigationParticipant</a>&nbsp;will have a chance to optimize <b id="c7kso2_121">Go To Root/Class/Symbol</b>&nbsp;actions.&nbsp;Instead of letting the default find usages and navigation implementations load all models into memory and process them in a standard way, by providing custom participants to <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/PersistenceFacade.java" id="c7kso2_122" data-external="true" rel="noopener noreferrer">PersistenceFacade</a> you have the option to access the persistent storage directly and thus speed-up search as well as navigation.</p></section></section><div class="last-modified">Last modified: 11 February 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="smodel-query-language.html" class="navigation-links__prev">SModel Query language</a><a href="using-model-module-dependencies-faq.html" class="navigation-links__next">Using model &amp; module dependencies FAQ</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/storage/help-app/v6/app.js"></script></body></html>